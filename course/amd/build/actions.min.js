define(["jquery","core/ajax","core/templates","core/notification","core/str","core/url","core/yui","core/fragment","core/modal_factory"],function(a,b,c,d,e,f,g,h,i){var j={EDITINPROGRESS:"editinprogress",SECTIONDRAGGABLE:"sectiondraggable",EDITINGMOVE:"editing_move"},k={ACTIVITYLI:"li.activity",ACTIONAREA:".actions",ACTIVITYACTION:"a.cm-edit-action",MENU:".moodle-actionmenu[data-enhance=moodle-core-actionmenu]",TOGGLE:".toggle-display,.dropdown-toggle",SECTIONLI:"li.section",SECTIONACTIONMENU:".section_action_menu",MODALCONTAINER:"div.modal",MODAL:"div.modal-content",FORM:"#mform1",SUBMITBUTTON:"#id_submitbutton",SUBMITBUTTON2:"#id_submitbutton2",CANCELBUTTON:"#id_cancel",CANCELBUTTON2:"div.modal-header button[data-action=hide]",URL_JUMP:"#chooserform input[type=hidden][name=jump]",BUTTON_ADD:"#chooserform input[type=submit][name=submitbutton]",SECTION_UL:"ul.section"};g.use("moodle-course-coursebase",function(){var a=M.course.format.get_section_selector();a&&(k.SECTIONLI=a)});var l=function(a){var b;return g.use("moodle-course-util",function(c){b=c.Moodle.core_course.util.cm.getId(c.Node(a.get(0)))}),b},m=function(a){var b;return g.use("moodle-course-util",function(c){b=c.Moodle.core_course.util.cm.getName(c.Node(a.get(0)))}),b},n=function(a){a.addClass(j.EDITINPROGRESS);var b=a.find(k.ACTIONAREA).get(0);if(b){var c=M.util.add_spinner(g,g.Node(b));return c.show(),c}return null},o=function(a){a.addClass(j.EDITINPROGRESS);var b=a.find(k.SECTIONACTIONMENU).get(0);if(b){var c=M.util.add_spinner(g,g.Node(b));return c.show(),c}return null},p=function(a){var b=M.util.add_lightbox(g,g.Node(a.get(0)));return b.show(),b},q=function(a,b,c){window.setTimeout(function(){a.removeClass(j.EDITINPROGRESS),b&&b.hide()},c)},r=function(a,b){a&&window.setTimeout(function(){a.hide()},b)},s=function(a,b){if(g.use("moodle-course-coursebase",function(){M.course.coursebase.invoke_function("setup_for_resource","#"+a)}),M.core.actionmenu&&M.core.actionmenu.newDOMNode&&M.core.actionmenu.newDOMNode(g.one("#"+a)),b){var c=g.one("#"+a+" "+k.MENU).one(k.TOGGLE);c&&c.simulate&&c.simulate("click")}},t=function(b,c){var d=a("#"+b),e="[data-action="+c+"]";"groupsseparate"!==c&&"groupsvisible"!==c&&"groupsnone"!==c||(e="[data-action=groupsseparate],[data-action=groupsvisible],[data-action=groupsnone]"),d.find(e).is(":visible")?d.find(e).focus():d.find(k.MENU).find(k.TOGGLE).focus()},u=function(b){var c=a("a:visible"),d=!1,e=null;return c.each(function(){if(a.contains(b[0],this))d=!0;else if(d)return e=this,!1}),e},v=function(a){var b={},c=a.substr(a.indexOf("?")+1).split("&");for(var d in c){var e=c[d].split("=");b[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return b},w=function(c,d,e){var f=e.attr("href"),g=v(f),h=b.call([{methodname:"core_course_get_course_module_editing_dialog",args:{update:d,sectionreturn:g.sr}}],!0),i=E();a.when.apply(a,h).done(function(a){F(i),x(c,a.html,a.javascript,d,g.module_type,g.sr)})},x=function(b,c,d,e,f,g){var h=a(d);h.splice(0,1);var j=z(h);G(),i.create({title:"Update "+f,body:c}).done(function(c){c.show(),a(k.MODAL).css({width:"800px",height:"500px",left:"50%","margin-left":"-400px",overflow:"auto",border:"1px solid black"}),a(k.SUBMITBUTTON2).click(function(a){a.preventDefault(),y(b,e,f,g,c)}),a(k.CANCELBUTTON+","+k.CANCELBUTTON2).on("click",function(a){a.preventDefault(),D(c)}),a("body").on("keydown",function(a){27===a.keyCode&&D(c)});var d="validate_mod_"+f+"_mod_form",h="document.getElementById('mform1').addEventListener";j=j.replace(h,"window.clientSideValidator="+d+";\n"+h);var i=document.createElement("script");i.textContent=j,document.head.appendChild(i)})},y=function(c,d,e,f,g){var h=!1;try{var i=window.clientSideValidator;"undefined"!=typeof window.tinyMCE&&window.tinyMCE.triggerSave(),h=i()}catch(j){h=!0}if(h){a(k.CANCELBUTTON).prop("disabled","disabled");var l=a(k.SUBMITBUTTON);null!==l&&l.prop("disabled","disabled");var m=b.call([{methodname:"core_course_submit_module_editing_form",args:{moduleid:d,sectionreturn:0,jsonformdata:JSON.stringify(a(k.FORM).serialize())}}],!0);a.when.apply(a,m).done(function(b){b.error?x(c,b.html,b.javascript,d,e,f):(c.replaceWith(b.html),a("<div>"+b.html+"</div>").find(k.ACTIVITYLI).each(function(){s(a(this).attr("id"),!1)}),D(g))})}},z=function(b){var c="";return b.each(function(b,d){d=a(d);var e=d.prop("tagName");if(e&&"script"==e.toLowerCase())if(d.attr("src")){var f=!1;a("script").each(function(b,c){return a(c).attr("src")==d.attr("src")&&(f=!0),!f}),f||(c+=" { ",c+=' node = document.createElement("script"); ',c+=' node.type = "text/javascript"; ',c+=' node.src = decodeURI("'+encodeURI(d.attr("src"))+'"); ',c+=' document.getElementsByTagName("head")[0].appendChild(node); ',c+=" } ")}else c+=" "+d.text()}),c},A=function(){var c=a(k.URL_JUMP).val(),d=v(c),e=a("#section-"+d.section+" "+k.SECTION_UL),f=b.call([{methodname:"core_course_get_course_module_adding_dialog",args:{courseid:d.id,section:d.section,add:d.add,sectionreturn:d.sr}}],!0);a(".addcancel").trigger("click");var g=E();a.when.apply(a,f).done(function(a){F(g),B(e,d.section,a.html,a.javascript,d.add,d.sr)})},B=function(b,c,d,e,f,g){var h=a(e);h.splice(0,1);var j=z(h);G(),i.create({title:"Add "+f,body:d}).done(function(d){d.show(),a(k.MODAL).css({width:"800px",height:"500px",left:"50%","margin-left":"-400px",overflow:"auto",border:"1px solid black"});var e="validate_mod_"+f+"_mod_form",h="document.getElementById('mform1').addEventListener";j=j.replace(h,"window.clientSideValidator="+e+";\n"+h);var i=document.createElement("script");i.textContent=j,document.head.appendChild(i),a(k.SUBMITBUTTON2).click(function(a){a.preventDefault(),C(b,c,f,d,g)}),a(k.CANCELBUTTON+","+k.CANCELBUTTON2).on("click",function(a){a.preventDefault(),D(d)}),a("body").on("keydown",function(a){27===a.keyCode&&D(d)})})},C=function(c,d,e,f,g){var h=!1;if(window.clientSideValidator)try{var i=window.clientSideValidator;"undefined"!=typeof window.tinyMCE&&window.tinyMCE.triggerSave(),h=i()}catch(j){h=!1}else h=!0;if(h){a(k.CANCELBUTTON).prop("disabled",!0),a(k.SUBMITBUTTON).prop("disabled",!0);var l=v(document.URL.split("#")[0]),m=b.call([{methodname:"core_course_submit_module_adding_form",args:{section:d,course:l.id,add:e,sectionreturn:g,jsonformdata:JSON.stringify(a(k.FORM).serialize())}}],!0);a.when.apply(a,m).done(function(b){b.error?B(c,d,b.html,b.javascript,e,g):(c.append(b.html),a("<div>"+b.html+"</div>").find(k.ACTIVITYLI).each(function(){s(a(this).attr("id"),!1)}),D(f))})}},D=function(a){a.hide(),window.onbeforeunload=null},E=function(){var b=M.util.add_lightbox(g,g.Node(a("body")[0]));return b.setStyle("position","fixed"),b.setStyle("z-index","1055"),b.show(),b},F=function(b){a("body").css("position","static"),b.remove()},G=function(){a(k.MODALCONTAINER).each(function(){this.remove()}),a("footer").siblings("script").each(function(){this.remove()}),window.onbeforeunload=null},H=function(c,e,f){var g,h=f.attr("data-keepopen"),i=f.attr("data-action"),j=n(c),l=b.call([{methodname:"core_course_edit_module",args:{id:e,action:i,sectionreturn:f.attr("data-sectionreturn")?f.attr("data-sectionreturn"):0}}],!0);"duplicate"===i&&(g=p(f.closest(k.SECTIONLI))),a.when.apply(a,l).done(function(b){var d=u(c);c.replaceWith(b),a("<div>"+b+"</div>").find(k.ACTIVITYLI).each(function(b){s(a(this).attr("id"),h),0===b&&(t(a(this).attr("id"),i),d=null)}),d&&d.focus(),q(c,j,400),r(g,400),c.trigger(a.Event("coursemoduleedited",{ajaxreturn:b,action:i}))}).fail(function(b){q(c,j),r(g);var e=a.Event("coursemoduleeditfailed",{exception:b,action:i});c.trigger(e),e.isDefaultPrevented()||d.exception(b)})},I=function(c,d,e){var f=n(c),g=b.call([{methodname:"core_course_get_module",args:{id:d,sectionreturn:e}}],!0);a.when.apply(a,g).done(function(a){q(c,f,400),O(a)}).fail(function(){q(c,f)})},J=function(a,b){var c=a.attr("class").match(/modtype_([^\s]*)/)[1],f=m(a);e.get_string("pluginname",c).done(function(a){var c={type:a,name:f};e.get_strings([{key:"confirm"},{key:null===f?"deletechecktype":"deletechecktypename",param:c},{key:"yes"},{key:"no"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],b)})})},K=function(a,b){e.get_strings([{key:"confirm"},{key:"yes"},{key:"no"}]).done(function(c){d.confirm(c[0],a,c[1],c[2],b)})},L=function(a,b,c,d,g,h,i){a.find("img").attr("src",f.imageUrl(b,"core")),e.get_string(c,d).done(function(b){a.find("span.menu-action-text").html(b),a.attr("title",b)}),g&&e.get_string(g,h).done(function(b){a.attr("title",b)}),a.attr("data-action",i)},N=function(b,c,d,e){var f=c.attr("data-action");if("hide"===f||"show"===f){if("hide"===f?(b.addClass("hidden"),L(c,"i/show","showfromothers","format_"+e,null,null,"show")):(b.removeClass("hidden"),L(c,"i/hide","hidefromothers","format_"+e,null,null,"hide")),void 0!==d.modules)for(var g in d.modules)O(d.modules[g]);void 0!==d.section_availability&&b.find(".section_availability").first().replaceWith(d.section_availability)}else if("setmarker"===f){var h=a(k.SECTIONLI+".current"),i=h.find(k.SECTIONACTIONMENU+" a[data-action=removemarker]");h.removeClass("current"),L(i,"i/marker","highlight","core","markthistopic","core","setmarker"),b.addClass("current"),L(c,"i/marked","highlightoff","core","markedthistopic","core","removemarker")}else"removemarker"===f&&(b.removeClass("current"),L(c,"i/marker","highlight","core","markthistopic","core","setmarker"))},O=function(b){a("<div>"+b+"</div>").find(k.ACTIVITYLI).each(function(){var c=a(this).attr("id");a(k.ACTIVITYLI+"#"+c).replaceWith(b),s(c,!1)})},P=function(c,e,f,g){var h=f.attr("data-action"),i=f.attr("data-sectionreturn")?f.attr("data-sectionreturn"):0,j=o(c),l=b.call([{methodname:"core_course_edit_section",args:{id:e,action:h,sectionreturn:i}}],!0),m=p(c);a.when.apply(a,l).done(function(b){var d=a.parseJSON(b);q(c,j),r(m),c.find(k.SECTIONACTIONMENU).find(k.TOGGLE).focus();var e=a.Event("coursesectionedited",{ajaxreturn:d,action:h});c.trigger(e),e.isDefaultPrevented()||N(c,f,d,g)}).fail(function(b){q(c,j),r(m);var e=a.Event("coursesectioneditfailed",{exception:b,action:h});c.trigger(e),e.isDefaultPrevented()||d.exception(b)})};return g.use("moodle-course-coursebase",function(){M.course.coursebase.register_module({set_visibility_resource_ui:function(b){var c=a(b.element.getDOMNode()),d=l(c);if(d){var e=c.find("."+j.EDITINGMOVE).attr("data-sectionreturn");I(c,d,e)}}})}),{initCoursePage:function(b){a("body").on("click keypress",k.ACTIVITYLI+" "+k.ACTIVITYACTION+"[data-action]",function(b){if("keypress"!==b.type||13===b.keyCode){var c=a(this),d=c.closest(k.ACTIVITYLI),e=c.attr("data-action"),f=l(d);switch(e){case"update":case"moveleft":case"moveright":case"delete":case"duplicate":case"hide":case"stealth":case"show":case"groupsseparate":case"groupsvisible":case"groupsnone":break;default:return}f&&(b.preventDefault(),"delete"===e?J(d,function(){H(d,f,c)}):"update"===e?w(d,f,c):H(d,f,c))}}),a("body").on("click keypress",k.BUTTON_ADD,function(a){a.preventDefault(),A()}),a("body").on("click keypress",k.SECTIONLI+" "+k.SECTIONACTIONMENU+"[data-sectionid] a[data-action]",function(c){if("keypress"!==c.type||13===c.keyCode){var d=a(this),e=d.closest(k.SECTIONLI),f=d.closest(k.SECTIONACTIONMENU).attr("data-sectionid");c.preventDefault(),d.attr("data-confirm")?K(d.attr("data-confirm"),function(){P(e,f,d,b)}):P(e,f,d,b)}})},replaceSectionActionItem:function(a,b,c,d,e,f,g,h){var i=a.find(k.SECTIONACTIONMENU+" "+b);L(i,c,d,e,f,g,h)}}});